# 3D Hand Project - 蓝牙连接功能

## 概述
3D Hand Project现已支持通过蓝牙低功耗（BLE）连接Arduino Nano BLE Sense Rev2设备，提供串口和蓝牙两种连接方式。

## 新增功能

### 1. 双连接模式支持
- **串口连接**: 使用Web Serial API（原有功能）
- **蓝牙连接**: 使用Web Bluetooth API（新增功能）
- **智能切换**: 根据浏览器支持情况自动启用/禁用连接模式

### 2. 用户界面改进
- 连接方式选择按钮
- 连接状态和类型显示
- 动态按钮文本更新
- 浏览器兼容性检测

### 3. 数据传输
- 支持实时传感器数据接收
- AI分析结果同步
- 命令发送（校准、分析、训练等）

## 文件结构

### 新增文件
- `bluetooth.js` - 蓝牙连接管理器
- `README_BLUETOOTH.md` - 本说明文档

### 修改文件
- `index.html` - 添加连接模式选择UI
- `script.js` - 集成蓝牙功能和双模式支持
- `styles.css` - 新增蓝牙相关样式

## 使用说明

### 1. 浏览器要求
- **Chrome 89+** (推荐)
- **Edge 89+** (推荐)
- **Firefox**: 不支持Web Bluetooth API
- **Safari**: 不支持Web Bluetooth API

### 2. 连接步骤

#### 串口连接（原有方式）
1. 选择"串口連接"模式
2. 点击"連接 Arduino (串口)"
3. 在弹出窗口中选择Arduino设备
4. 等待连接成功

#### 蓝牙连接（新增方式）
1. 确保Arduino已上传支持BLE的代码
2. 选择"蓝牙連接"模式
3. 点击"連接 Arduino (蓝牙)"
4. 在蓝牙设备列表中选择"ParkinsonDevice_v2"
5. 等待连接成功

### 3. 功能特性

#### 自动检测
- 页面加载时自动检测浏览器支持情况
- 不支持的连接方式会被禁用
- 显示相应的提示信息

#### 状态显示
- 连接状态指示器（绿色=已连接，红色=未连接）
- 连接类型标签（串口/蓝牙）
- 实时状态文本更新

#### 数据同步
- 传感器数据实时更新
- 3D手部模型同步
- AI分析结果显示

## 技术实现

### 蓝牙数据格式
```javascript
// 传感器数据 (60字节二进制)
{
    fingers: [uint16, uint16, uint16, uint16, uint16],  // 手指数据
    accelerometer: {x: float, y: float, z: float},      // 加速度计
    gyroscope: {x: float, y: float, z: float},          // 陀螺仪
    magnetometer: {x: float, y: float, z: float}        // 磁力计
}

// AI结果 (文本格式)
"AI:level,confidence,count"
// 例如: "AI:3,85.6,5"
```

### BLE服务和特征值
- **服务UUID**: `12345678-1234-1234-1234-123456789abc`
- **传感器数据**: `12345678-1234-1234-1234-123456789abd` (Read/Notify)
- **命令发送**: `12345678-1234-1234-1234-123456789abe` (Write)
- **AI结果**: `12345678-1234-1234-1234-123456789abf` (Read/Notify)

### 支持的命令
- `START` - 开始数据收集
- `TRAIN` - 开始训练
- `CALIBRATE` - 校准传感器
- `STATUS` - 查询状态
- `AUTO` - 开始AI分析
- `STOP` - 停止分析

## 故障排除

### 问题1：蓝牙连接失败
**可能原因**:
- 浏览器不支持Web Bluetooth API
- Arduino设备未开启BLE广播
- 设备距离过远

**解决方案**:
1. 使用Chrome或Edge浏览器
2. 确认Arduino已上传BLE版本代码
3. 将设备靠近电脑
4. 重启Arduino设备

### 问题2：找不到蓝牙设备
**可能原因**:
- 设备名称不匹配
- BLE服务未正确初始化

**解决方案**:
1. 检查Arduino串口监视器确认BLE初始化成功
2. 确认设备名称为"ParkinsonDevice_v2"
3. 重新上传Arduino代码

### 问题3：数据传输异常
**可能原因**:
- BLE连接不稳定
- 数据格式解析错误

**解决方案**:
1. 检查设备距离和信号强度
2. 查看浏览器控制台错误信息
3. 重新连接设备

### 问题4：浏览器兼容性
**解决方案**:
- 使用Chrome 89+或Edge 89+
- 启用实验性Web平台功能（如需要）
- 更新浏览器到最新版本

## 开发说明

### 添加新命令
在`bluetooth.js`的`sendCommand`方法中添加新命令支持，同时在Arduino代码中添加相应的命令处理。

### 修改数据格式
如需修改传感器数据格式，需要同时更新：
1. Arduino代码中的`sendDataViaBLE`函数
2. `bluetooth.js`中的`parseSensorData`函数

### 扩展功能
可以通过添加新的BLE特征值来扩展功能，例如：
- 设备配置参数
- 历史数据查询
- 固件更新

## 性能优化

### 数据传输优化
- 使用二进制格式减少数据包大小
- 合理设置数据发送间隔（100ms）
- 实现数据缓冲和批量处理

### 连接稳定性
- 自动重连机制
- 连接状态监控
- 错误恢复处理

### 用户体验
- 智能模式切换
- 实时状态反馈
- 友好的错误提示

## 版本信息
- 版本：2.0
- 更新日期：2025-08-09
- 兼容性：Arduino Nano 33 BLE Sense Rev2
- 浏览器：Chrome 89+, Edge 89+
