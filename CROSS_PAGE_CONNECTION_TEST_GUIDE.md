# 跨页面连接功能测试指南

## 🚀 快速测试步骤

### 1. 启动应用
```bash
cd parkinson-dock-ui
npm run dev
# 访问 http://localhost:3000
```

### 2. 基本连接测试

#### 步骤1：在设备页面建立连接
1. 访问 `http://localhost:3000/device`
2. 选择连接方式（串口或蓝牙）
3. 点击连接按钮
4. 确认连接成功（绿色指示器）

#### 步骤2：测试跨页面状态同步
1. 保持设备页面连接状态
2. 打开新标签页访问 `http://localhost:3000/ai-analysis`
3. **验证**: AI分析页面应显示"已连接"状态
4. **验证**: 连接类型和设备名称应正确显示

#### 步骤3：测试数据共享
1. 在设备页面观察实时传感器数据
2. 切换到AI分析页面
3. **验证**: 传感器数据应在两个页面同步更新
4. **验证**: 数据更新频率应一致

### 3. 高级功能测试

#### 测试A：多页面同时操作
1. 打开3个标签页：
   - `http://localhost:3000/` (主页)
   - `http://localhost:3000/device` (设备页)
   - `http://localhost:3000/ai-analysis` (AI分析页)
2. 在设备页面连接设备
3. **验证**: 所有页面的连接状态指示器都变为绿色
4. 在AI分析页面发送命令
5. **验证**: 设备页面应显示相应的数据变化

#### 测试B：页面刷新恢复
1. 在设备页面建立连接
2. 刷新浏览器页面
3. **验证**: 页面重新加载后连接状态应自动恢复
4. **验证**: 设备名称和连接类型应正确显示

#### 测试C：连接切换
1. 建立串口连接
2. 在任意页面断开连接
3. 切换到蓝牙连接
4. **验证**: 所有页面应同步显示新的连接状态

### 4. 错误处理测试

#### 测试D：连接中断处理
1. 建立设备连接
2. 物理断开设备（拔掉USB或关闭蓝牙）
3. **验证**: 所有页面应显示"连接中断"状态
4. **验证**: 错误信息应清晰显示

#### 测试E：浏览器兼容性
1. 使用Chrome浏览器测试完整功能
2. 使用Edge浏览器测试
3. 使用Firefox测试（应显示不支持蓝牙的提示）
4. **验证**: 不支持的功能应有友好提示

## 🔍 详细测试清单

### 连接管理测试
- [ ] 串口连接建立成功
- [ ] 蓝牙连接建立成功
- [ ] 连接状态在所有页面同步
- [ ] 断开连接在所有页面同步
- [ ] 连接类型切换正常
- [ ] 设备名称正确显示
- [ ] 连接错误信息正确显示

### 数据传输测试
- [ ] 传感器数据实时更新
- [ ] 数据在多页面同步
- [ ] AI分析结果正确接收
- [ ] 命令发送成功
- [ ] 数据格式解析正确
- [ ] 数据传输频率稳定

### 用户界面测试
- [ ] 连接状态指示器正确
- [ ] 连接控制按钮状态正确
- [ ] 错误信息显示友好
- [ ] 加载状态指示清晰
- [ ] 响应式设计正常
- [ ] 深色模式兼容

### 跨页面功能测试
- [ ] 页面间状态同步
- [ ] 页面刷新状态恢复
- [ ] 多标签页同时工作
- [ ] BroadcastChannel通信正常
- [ ] localStorage状态持久化
- [ ] 状态过期机制正常

### 性能测试
- [ ] 连接建立速度合理
- [ ] 数据传输延迟低
- [ ] 内存使用稳定
- [ ] CPU使用率正常
- [ ] 长时间运行稳定
- [ ] 多页面性能影响小

## 🐛 常见问题及解决方案

### 问题1：页面间状态不同步
**现象**: 在一个页面连接设备后，其他页面仍显示未连接

**检查步骤**:
1. 打开浏览器开发者工具
2. 查看Console是否有BroadcastChannel错误
3. 检查localStorage中是否有连接状态数据
4. 手动点击"刷新"按钮

**解决方案**:
```javascript
// 在浏览器控制台手动刷新状态
const manager = GlobalConnectionManager.getInstance();
manager.requestConnectionState();
```

### 问题2：连接状态丢失
**现象**: 页面刷新后连接状态消失

**检查步骤**:
1. 检查localStorage权限
2. 确认连接状态未过期（5分钟）
3. 查看是否有JavaScript错误

**解决方案**:
```javascript
// 手动恢复连接状态
localStorage.setItem('parkinson-connection-state', JSON.stringify({
  isConnected: true,
  connectionType: 'bluetooth',
  deviceName: 'ParkinsonDevice_v2',
  lastUpdate: Date.now()
}));
```

### 问题3：数据不更新
**现象**: 连接成功但传感器数据不更新

**检查步骤**:
1. 确认Arduino设备正在发送数据
2. 检查数据解析是否正确
3. 查看网络连接状态

**解决方案**:
1. 重新连接设备
2. 检查Arduino串口输出
3. 验证数据格式匹配

### 问题4：重复连接错误
**现象**: 尝试连接时提示设备已连接

**解决方案**:
```javascript
// 强制断开并重新连接
const manager = GlobalConnectionManager.getInstance();
await manager.disconnect();
await manager.connectBluetooth(); // 或 connectSerial()
```

## 📊 性能基准

### 连接性能
- 串口连接建立: < 2秒
- 蓝牙连接建立: < 5秒
- 页面间状态同步: < 100ms
- 数据传输延迟: < 50ms

### 资源使用
- 内存使用: < 50MB
- CPU使用: < 5%
- 网络带宽: 最小
- 电池影响: 低

## 🔧 调试工具

### 浏览器控制台命令
```javascript
// 获取全局连接管理器
const manager = GlobalConnectionManager.getInstance();

// 查看连接状态
console.log(manager.getConnectionState());

// 查看浏览器支持
console.log(manager.getBrowserSupport());

// 手动发送命令
await manager.sendCommand('STATUS');

// 强制断开连接
await manager.disconnect();
```

### 状态监控
```javascript
// 监控连接状态变化
const manager = GlobalConnectionManager.getInstance();
manager.setCallbacks({
  onConnectionStateChanged: (state) => {
    console.log('Connection state changed:', state);
  },
  onDataReceived: (data) => {
    console.log('Data received:', data);
  }
});
```

## ✅ 测试通过标准

### 基本功能
- ✅ 所有连接方式正常工作
- ✅ 跨页面状态同步正常
- ✅ 数据传输稳定可靠
- ✅ 错误处理完善

### 用户体验
- ✅ 界面响应迅速
- ✅ 状态指示清晰
- ✅ 错误信息友好
- ✅ 操作流程顺畅

### 技术指标
- ✅ 连接成功率 > 95%
- ✅ 数据传输延迟 < 100ms
- ✅ 内存使用 < 100MB
- ✅ 无内存泄漏

## 📝 测试报告模板

```
测试日期: ___________
测试环境: ___________
浏览器版本: ___________
测试人员: ___________

基本功能测试:
- 串口连接: [ ] 通过 [ ] 失败
- 蓝牙连接: [ ] 通过 [ ] 失败
- 跨页面同步: [ ] 通过 [ ] 失败

高级功能测试:
- 多页面操作: [ ] 通过 [ ] 失败
- 页面刷新恢复: [ ] 通过 [ ] 失败
- 连接切换: [ ] 通过 [ ] 失败

性能测试:
- 连接速度: ____秒
- 数据延迟: ____ms
- 内存使用: ____MB

问题记录:
1. ________________
2. ________________
3. ________________

总体评价: [ ] 优秀 [ ] 良好 [ ] 需改进
```

## 🎯 下一步测试

完成基本测试后，可以进行以下高级测试：

1. **压力测试**: 长时间运行和大量数据传输
2. **兼容性测试**: 不同操作系统和浏览器
3. **网络测试**: 不同网络环境下的表现
4. **安全测试**: 数据传输安全性验证
5. **可用性测试**: 真实用户使用场景测试

---

**🎉 测试完成后，您的跨页面连接功能应该能够稳定可靠地工作！**
