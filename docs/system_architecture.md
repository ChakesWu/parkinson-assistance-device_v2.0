# 帕金森輔助裝置系統架構

## 系統概述

本系統是一個基於Arduino Nano 33 BLE Sense Rev2的智能帕金森輔助裝置，結合了多傳感器數據收集、CNN-LSTM深度學習模型和個性化訓練方案，為帕金森患者提供客觀的症狀評估和有效的康復訓練。

## 系統架構圖

```
┌─────────────────────────────────────────────────────────────┐
│                    帕金森輔助裝置系統                          │
├─────────────────────────────────────────────────────────────┤
│  硬體層 (Arduino Nano 33 BLE Sense Rev2)                    │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ 手指彎曲感測  │ │   EMG感測   │ │  IMU感測器  │           │
│  │ (電位器×5)   │ │   (肌電圖)  │ │ (加速度計)  │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│           │               │               │                │
│  ┌─────────────────────────────────────────────────────────┤
│  │              數據處理和AI推理                           │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │
│  │  │  數據校準    │ │ CNN-LSTM模型 │ │  結果分析    │      │
│  │  │  和預處理    │ │   (TFLite)  │ │  和建議      │      │
│  │  └─────────────┘ └─────────────┘ └─────────────┘      │
│  └─────────────────────────────────────────────────────────┤
│           │                                               │
│  ┌─────────────────────────────────────────────────────────┤
│  │                輸出和控制                              │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │
│  │  │   舵機控制   │ │  串口通信    │ │  狀態指示    │      │
│  │  │  (阻力訓練)  │ │  (數據傳輸) │ │   (LED)     │      │
│  │  └─────────────┘ └─────────────┘ └─────────────┘      │
│  └─────────────────────────────────────────────────────────┤
└─────────────────────────────────────────────────────────────┘
│
├─────────────────────────────────────────────────────────────┤
│                Python後端支持系統                           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │  數據收集    │ │  模型訓練    │ │  結果分析    │           │
│  │   系統      │ │   和優化    │ │   和報告    │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
```

## 核心組件

### 1. 硬體感測層

#### 手指彎曲感測 (電位器)
- **數量**: 5個 (每根手指一個)
- **連接**: A0-A4引腳
- **功能**: 檢測手指彎曲角度，評估精細動作控制
- **自適應**: 支持設備未連接時的模擬信號模式

#### EMG肌電感測
- **連接**: A5引腳
- **功能**: 監測肌肉活動和疲勞程度
- **特點**: 可檢測肌肉震顫和控制穩定性

#### IMU慣性測量單元
- **內建**: Arduino Nano 33 BLE Sense Rev2
- **數據**: 三軸加速度計 (x, y, z)
- **功能**: 分析運動平滑度、平衡能力和震顫頻率

### 2. AI推理引擎

#### CNN-LSTM混合模型
```
輸入層 [50 × 9] → CNN特徵提取 → LSTM時序分析 → 分類輸出 [5類]
```

**模型特點**:
- **CNN部分**: 提取空間特徵模式
- **LSTM部分**: 捕捉時間序列依賴
- **注意力機制**: 重點關注關鍵特徵
- **量化優化**: TensorFlow Lite INT8量化

#### 推理性能
- **模型大小**: ~60KB (量化後)
- **推理時間**: <100ms
- **準確率**: >85% (驗證集)
- **內存需求**: 60KB Arena

### 3. 帕金森等級分析

#### 分級標準
| 等級 | 描述 | 症狀特徵 | 訓練強度 |
|------|------|----------|----------|
| 1級  | 輕度 | 輕微震顫，日常活動正常 | 低強度，30度阻力 |
| 2級  | 輕中度 | 震顫增加，精細動作受影響 | 低中強度，60度阻力 |
| 3級  | 中度 | 明顯運動遲緩，平衡問題 | 中強度，90度阻力 |
| 4級  | 中重度 | 嚴重運動障礙，需要輔助 | 中高強度，120度阻力 |
| 5級  | 重度 | 行動嚴重受限，需要照護 | 適應性，150度阻力 |

#### 分析指標
- **手指靈活性**: 基於彎曲角度變化
- **協調性**: 多手指動作相關性
- **震顫指數**: 高頻運動成分分析
- **肌肉疲勞**: EMG信號衰減模式
- **平衡能力**: IMU穩定性評估

### 4. 個性化訓練系統

#### 訓練方案生成
```python
def generate_training_plan(level, symptoms):
    base_plan = templates[level]
    
    # 根據震顫程度調整
    if tremor_high:
        reduce_resistance()
        add_tremor_control()
    
    # 根據肌力調整
    if muscle_weak:
        add_strength_training()
        extend_duration()
    
    return personalized_plan
```

#### 舵機阻力控制
- **角度範圍**: 0-180度
- **阻力映射**: 線性映射帕金森等級到阻力強度
- **訓練模式**: 漸進式阻力增加
- **安全保護**: 最大角度限制和緊急停止

## 數據流程

### 1. 數據收集流程
```
傳感器讀取 → 基線校準 → 標準化處理 → 滑動窗口緩衝 → AI推理
```

### 2. 推理流程
```
50×9輸入序列 → CNN特徵提取 → LSTM時序建模 → Softmax分類 → 結果輸出
```

### 3. 控制流程
```
AI分析結果 → 等級判定 → 訓練方案生成 → 舵機控制參數 → 執行訓練
```

## 通信協議

### 串口命令格式
```
命令類型:
- START: 開始數據收集
- TRAIN: 開始訓練模式  
- LEVEL,{1-5}: 設定帕金森等級
- SERVO,{0-180}: 舵機角度控制
- STATUS: 查看系統狀態

數據格式:
- DATA,f1,f2,f3,f4,f5,emg,imu_x,imu_y,imu_z
- TRAIN_DATA,angle,imu_x,imu_y,imu_z
```

### 實時分析模式
- **採樣頻率**: 10Hz (100ms間隔)
- **推理頻率**: 0.2Hz (5秒間隔)
- **緩衝大小**: 50個時間點
- **滑動窗口**: 連續更新

## 系統特性

### 智能特性
- **自動設備檢測**: 檢測電位器和EMG連接狀態
- **模擬信號生成**: 設備未連接時提供測試信號
- **自適應校準**: 動態調整基線參考值
- **實時推理**: 邊緣AI推理，無需雲端連接

### 安全特性
- **阻力限制**: 防止過度訓練傷害
- **緊急停止**: 按鈕快速停止所有操作
- **狀態監控**: LED指示和串口狀態報告
- **錯誤處理**: 全面的異常處理和恢復

### 擴展特性
- **藍牙連接**: 支持無線數據傳輸
- **存儲功能**: 本地數據記錄和歷史分析
- **多用戶**: 支持多患者配置文件
- **雲端同步**: 可擴展至雲端平台

## 性能指標

### 準確性指標
- **分類準確率**: >85%
- **震顫檢測**: >90%
- **等級一致性**: 與醫生評估correlation >0.8

### 實時性指標
- **數據延遲**: <100ms
- **推理延遲**: <100ms
- **響應時間**: <200ms (命令到執行)

### 可靠性指標
- **連續運行**: >24小時無故障
- **數據完整性**: >99.9%
- **系統穩定性**: MTBF >1000小時

## 開發和部署

### 開發環境
- **Arduino IDE**: 1.8.19+
- **Python**: 3.8+
- **TensorFlow**: 2.10+
- **必要庫**: 見requirements.txt

### 部署步驟
1. 硬體組裝和接線
2. Arduino代碼上傳
3. Python環境配置
4. 數據收集和模型訓練
5. 模型量化和部署
6. 系統測試和驗證

### 維護和更新
- **模型更新**: 重新訓練和量化
- **固件更新**: Arduino代碼更新
- **參數調整**: 基於使用反饋優化
- **功能擴展**: 新傳感器和算法集成