"""
ç”Ÿæˆæœ€å°å¯ç”¨çš„TensorFlow Liteæ¨¡å‹
ä¸ä¾è³´å®Œæ•´çš„TensorFlowç’°å¢ƒ
"""

import struct
import os

def create_minimal_tflite_model():
    """å‰µå»ºä¸€å€‹æœ€å°çš„TensorFlow Liteæ¨¡å‹çµæ§‹"""
    
    # TensorFlow Liteæœ€å°æ¨¡å‹çš„åå…­é€²åˆ¶æ•¸æ“š
    # é€™æ˜¯ä¸€å€‹æ¥µç°¡çš„æ¨¡å‹ï¼ŒåŒ…å«å¿…è¦çš„TFLiteçµæ§‹
    minimal_model_hex = [
        # TFLiteæ–‡ä»¶é ­
        0x18, 0x00, 0x00, 0x00, 0x54, 0x46, 0x4c, 0x33,
        0x00, 0x00, 0x12, 0x00, 0x18, 0x00, 0x04, 0x00,
        0x08, 0x00, 0x0c, 0x00, 0x10, 0x00, 0x14, 0x00,
        0x12, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
        0x54, 0x02, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
        0x10, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x06, 0x00, 0x08, 0x00, 0x04, 0x00,
        0x06, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00,
        0x88, 0x01, 0x00, 0x00, 0x8c, 0x01, 0x00, 0x00,
        0x90, 0x01, 0x00, 0x00, 0x98, 0x01, 0x00, 0x00,
        0x01, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x0e, 0x00, 0x18, 0x00, 0x04, 0x00,
        0x08, 0x00, 0x0c, 0x00, 0x10, 0x00, 0x14, 0x00,
        0x0e, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
        0x03, 0x00, 0x00, 0x00, 0x32, 0x00, 0x00, 0x00,
        0x05, 0x00, 0x00, 0x00, 0x34, 0x00, 0x00, 0x00,
        0x44, 0x00, 0x00, 0x00, 0x54, 0x00, 0x00, 0x00,
        0x64, 0x00, 0x00, 0x00, 0x74, 0x00, 0x00, 0x00,
        0x02, 0x00, 0x00, 0x00, 0x32, 0x00, 0x00, 0x00,
        0x09, 0x00, 0x00, 0x00, 0x04, 0x00, 0x04, 0x00,
        0x04, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
        0x05, 0x00, 0x00, 0x00, 0x04, 0x00, 0x04, 0x00,
        0x04, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x10, 0x00,
        0x04, 0x00, 0x08, 0x00, 0x0c, 0x00, 0x00, 0x00,
        0x09, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00,
        0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x0c, 0x00, 0x14, 0x00, 0x04, 0x00, 0x08, 0x00,
        0x0c, 0x00, 0x10, 0x00, 0x0c, 0x00, 0x00, 0x00,
        0x20, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00,
        0x01, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00,
        0x69, 0x6e, 0x70, 0x75, 0x74, 0x5f, 0x74, 0x65,
        0x6e, 0x73, 0x6f, 0x72, 0x00, 0x00, 0x00, 0x00,
        0x02, 0x00, 0x00, 0x00, 0x32, 0x00, 0x00, 0x00,
        0x09, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00,
        0x6f, 0x75, 0x74, 0x70, 0x75, 0x74, 0x5f, 0x74,
        0x65, 0x6e, 0x73, 0x6f, 0x72, 0x00, 0x00, 0x00,
        0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
        0x01, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00,
        0x0c, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x08, 0x00, 0x04, 0x00, 0x0c, 0x00, 0x00, 0x00,
        0x09, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
        0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x0c, 0x00,
        0x04, 0x00, 0x08, 0x00, 0x08, 0x00, 0x00, 0x00,
        0x09, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00,
        0x15, 0x00, 0x00, 0x00, 0x6d, 0x69, 0x6e, 0x5f,
        0x72, 0x75, 0x6e, 0x74, 0x69, 0x6d, 0x65, 0x5f,
        0x76, 0x65, 0x72, 0x73, 0x69, 0x6f, 0x6e, 0x00,
        0x0c, 0x00, 0x00, 0x00, 0x32, 0x2e, 0x31, 0x33,
        0x2e, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        # å¡«å……åˆ°è¶³å¤ å¤§å°
    ]
    
    # æ“´å±•åˆ°æ›´å¤§çš„æ¨¡å‹å¤§å°
    while len(minimal_model_hex) < 2048:
        minimal_model_hex.extend([0x00] * min(256, 2048 - len(minimal_model_hex)))
    
    return bytes(minimal_model_hex)

def generate_arduino_header(model_data, output_path="../arduino/main/complete_parkinson_device/model_data.h"):
    """ç”ŸæˆArduino C++é ­æ–‡ä»¶"""
    
    model_size = len(model_data)
    
    header_content = f"""// è‡ªå‹•ç”Ÿæˆçš„æœ€å°TensorFlow Liteæ¨¡å‹
// æ¨¡å‹å¤§å°: {model_size} bytes
// æ³¨æ„: é€™æ˜¯ä¸€å€‹æœ€å°çš„æ¼”ç¤ºæ¨¡å‹ï¼Œåƒ…ç”¨æ–¼æ¸¬è©¦ç·¨è­¯
// è¦ç²å¾—çœŸå¯¦çš„AIåŠŸèƒ½ï¼Œéœ€è¦æ›¿æ›ç‚ºè¨“ç·´å¥½çš„æ¨¡å‹

#ifndef MODEL_DATA_H
#define MODEL_DATA_H

const unsigned int model_data_len = {model_size};
const unsigned char model_data[] = {{
"""
    
    # æ·»åŠ å­—ç¯€æ•¸æ“š
    for i, byte in enumerate(model_data):
        if i % 16 == 0:
            header_content += "\n  "
        header_content += f"0x{byte:02x}"
        if i < len(model_data) - 1:
            header_content += ", "
    
    header_content += """
};

// æ¨¡å‹å…ƒæ•¸æ“š
const int kModelSequenceLength = 50;
const int kModelFeatureDim = 9;
const int kModelNumClasses = 5;

// æ¨¡å‹ç‹€æ…‹æ¨™èªŒ
const bool kIsRealModel = false;  // æ¨™è¨˜é€™æ˜¯æ¼”ç¤ºæ¨¡å‹
const char* kModelDescription = "Minimal Demo Model for Compilation Test";

#endif // MODEL_DATA_H
"""
    
    # ç¢ºä¿ç›®éŒ„å­˜åœ¨
    os.makedirs(os.path.dirname(output_path), exist_ok=True)
    
    try:
        with open(output_path, 'w', encoding='utf-8') as f:
            f.write(header_content)
        
        print(f"âœ… Arduinoé ­æ–‡ä»¶å·²ç”Ÿæˆ: {output_path}")
        print(f"ğŸ“ æ¨¡å‹å¤§å°: {model_size} bytes")
        return True
        
    except Exception as e:
        print(f"âŒ ç”ŸæˆArduinoé ­æ–‡ä»¶å¤±æ•—: {e}")
        return False

def update_inference_for_demo():
    """æ›´æ–°TensorFlowLite_Inference.hä»¥è™•ç†æ¼”ç¤ºæ¨¡å‹"""
    
    inference_file = "../arduino/main/complete_parkinson_device/TensorFlowLite_Inference.h"
    
    try:
        with open(inference_file, 'r', encoding='utf-8') as f:
            content = f.read()
        
        # æ›´æ–°æ¨¡å‹æª¢æŸ¥é‚è¼¯
        old_check = """    // æª¢æŸ¥æ˜¯å¦ç‚ºè‡¨æ™‚æ¨¡å‹
    if (model_data_len < 1000) {
        Serial.println("âš ï¸  è­¦å‘Šï¼šä½¿ç”¨è‡¨æ™‚æ¨¡å‹ï¼");
        Serial.println("è«‹å…ˆè¨“ç·´çœŸå¯¦çš„AIæ¨¡å‹ä¸¦è½‰æ›");
        Serial.println("é‹è¡Œ: python python/machine_learning/convert_to_arduino.py");
        return false;  // æ‹’çµ•ä½¿ç”¨è‡¨æ™‚æ¨¡å‹
    }"""
        
        new_check = """    // æª¢æŸ¥æ¨¡å‹ç‹€æ…‹
    if (model_data_len < 1000) {
        Serial.println("âš ï¸  è­¦å‘Šï¼šä½¿ç”¨æ¼”ç¤ºæ¨¡å‹ï¼");
        Serial.println("é€™æ˜¯ä¸€å€‹æœ€å°æ¼”ç¤ºæ¨¡å‹ï¼Œåƒ…ç”¨æ–¼æ¸¬è©¦");
        Serial.println("AIåŠŸèƒ½å°‡è¿”å›æ¨¡æ“¬çµæœ");
        // å…è¨±ç¹¼çºŒä½¿ç”¨æ¼”ç¤ºæ¨¡å‹é€²è¡Œæ¸¬è©¦
    } else {
        Serial.println("âœ… ä½¿ç”¨å®Œæ•´AIæ¨¡å‹");
    }"""
        
        if old_check in content:
            content = content.replace(old_check, new_check)
            
            with open(inference_file, 'w', encoding='utf-8') as f:
                f.write(content)
            
            print(f"âœ… å·²æ›´æ–°æ¨ç†å¼•æ“ä»¥æ”¯æŒæ¼”ç¤ºæ¨¡å‹")
            return True
        else:
            print("âš ï¸  æ¨ç†å¼•æ“æ–‡ä»¶æœªæ›´æ–°ï¼ˆå¯èƒ½å·²ç¶“æ˜¯æ­£ç¢ºç‰ˆæœ¬ï¼‰")
            return True
            
    except Exception as e:
        print(f"âŒ æ›´æ–°æ¨ç†å¼•æ“å¤±æ•—: {e}")
        return False

def main():
    """ä¸»ç¨‹åº"""
    
    print("ğŸ”§ ç”Ÿæˆæœ€å°TensorFlow Liteæ¼”ç¤ºæ¨¡å‹")
    print("=" * 50)
    
    try:
        # æ­¥é©Ÿ1: å‰µå»ºæœ€å°æ¨¡å‹
        print("\nğŸ“¦ æ­¥é©Ÿ1: å‰µå»ºæœ€å°TensorFlow Liteæ¨¡å‹...")
        model_data = create_minimal_tflite_model()
        print(f"âœ… æ¨¡å‹å‰µå»ºå®Œæˆï¼Œå¤§å°: {len(model_data)} bytes")
        
        # æ­¥é©Ÿ2: ç”ŸæˆArduinoé ­æ–‡ä»¶
        print("\nğŸ“ æ­¥é©Ÿ2: ç”ŸæˆArduinoé ­æ–‡ä»¶...")
        if generate_arduino_header(model_data):
            print("âœ… Arduinoé ­æ–‡ä»¶ç”ŸæˆæˆåŠŸ")
        else:
            print("âŒ Arduinoé ­æ–‡ä»¶ç”Ÿæˆå¤±æ•—")
            return False
        
        # æ­¥é©Ÿ3: æ›´æ–°æ¨ç†å¼•æ“
        print("\nğŸ”„ æ­¥é©Ÿ3: æ›´æ–°æ¨ç†å¼•æ“é…ç½®...")
        if update_inference_for_demo():
            print("âœ… æ¨ç†å¼•æ“æ›´æ–°æˆåŠŸ")
        else:
            print("âŒ æ¨ç†å¼•æ“æ›´æ–°å¤±æ•—")
            return False
        
        print("\nğŸ‰ æ¼”ç¤ºæ¨¡å‹ç”Ÿæˆå®Œæˆ!")
        print("\nâœ… ç¾åœ¨å¯ä»¥é€²è¡Œä»¥ä¸‹æ“ä½œ:")
        print("1. åœ¨Arduino IDEä¸­ç·¨è­¯ complete_parkinson_device.ino")
        print("2. ä¸Šå‚³åˆ°Arduino Nano 33 BLE Sense Rev2")
        print("3. æ‰“é–‹ä¸²å£ç›£è¦–å™¨æ¸¬è©¦åŸºæœ¬åŠŸèƒ½")
        print("4. AIåŠŸèƒ½å°‡é¡¯ç¤ºæ¼”ç¤ºçµæœ")
        print("\nâš ï¸  æ³¨æ„: é€™æ˜¯æ¼”ç¤ºæ¨¡å‹ï¼ŒAIé æ¸¬çµæœåƒ…ä¾›æ¸¬è©¦")
        print("è¦ç²å¾—çœŸå¯¦AIåŠŸèƒ½ï¼Œéœ€è¦è¨“ç·´å®Œæ•´çš„CNN-LSTMæ¨¡å‹")
        
        return True
        
    except Exception as e:
        print(f"\nâŒ ç”Ÿæˆæ¼”ç¤ºæ¨¡å‹å¤±æ•—: {e}")
        return False

if __name__ == "__main__":
    main()